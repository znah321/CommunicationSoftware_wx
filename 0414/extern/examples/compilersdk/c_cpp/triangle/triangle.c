/*=================================================================
 *
 * TRIANGLE.C
 *
 * Calculate the points in Sierpinski's triangle, an elementary
 * fractal. 
 *
 * This function calls a shared library, libtriangle, created
 * using MATLAB Compiler SDK.
 *
 * Copyright 1984-2018 The MathWorks, Inc.
 *
 *=================================================================*/

#include <stdio.h>

/* Include the library specific header file as generated by MATLAB Compiler SDK
 * for the C shared library target; this includes the MCLMCRRT proxy layer 
 * header automatically.
 */
#include "libtriangle.h"

void usage(const char *name)
{
    printf("Usage: %s [number of points; default=7500]\n",name); 
    exit (-1);
}

int run_main(int argc, const char ** argv)
{
    /* Input parameters:
     *
     * iterations: Number of points to draw in the triangle
     * draw: If true, draw the triangle in a figure window before returning. 
     * In this code, the value of draw is always set to true.
     */
    mxArray *iterations = NULL, *draw = NULL;

    /* The Sierpinski function returns the X and Y coordinates of the points
     * forming the pattern in the triangle.
     */
    mxArray *x = NULL, *y = NULL;

    /* Default number of iterations */
    int num_points = 7500;

    /* Validate the number of inputs */
    if (argc < 1 || argc > 2)
    {
        fprintf(stderr, "Expecting 0 or 1 input(s). Found %d.\n", argc-1);
        usage((argc > 0) ? argv[0] : "triangle");
        return -1;
    }

    /* If we have an input, try to convert the input
     * string to an integer.
     */
    if (argc == 2)
    {
        num_points = atoi(argv[1]);
    }
    
    /* Type check on input argument -- atoi() will return 0 if the input is
     * not an integer.
     */
    if (num_points < 1)
    {
        fprintf(stderr, "Argument must be a positive integer.\n");
        usage((argc > 0) ? argv[0] : "triangle");
        return -2;
    }

    /* Call the library intialization routine and make sure that the
     * library was initialized properly
     */
    if (!libtriangleInitialize())
    {
        fprintf(stderr,"could not initialize the triangle library properly\n");
        return -3;
    }
    else
    {
        /* Create the input data */
        iterations = mxCreateDoubleScalar(num_points);
        draw = mxCreateLogicalScalar(1);
        
        /* Call the library function */
        mlfSierpinski(2, &x, &y, iterations, draw);
        
        /* Display the return value of the library function */
#ifdef _WIN32
        printf("Calculated %Iu points\n", mxGetNumberOfElements(x));
#else
        printf("Calculated %zu points\n", mxGetNumberOfElements(x));
#endif
        printf("Close the figure to continue\n");
        /* Block until user dismisses the figure */
        mclWaitForFiguresToDie(NULL);
        
        /* Free the memory used by the return values. */
        mxDestroyArray(x); x=NULL;
        mxDestroyArray(y); y=NULL;
        
        /* Call the library termination routine */
        libtriangleTerminate();
        
        /* Free the memory used by the input variables */
        mxDestroyArray(iterations); iterations=0;
        mxDestroyArray(draw); draw = 0;
    }
    /* Note that you should call mclTerminateApplication at the end of
     * your application to shut down all MATLAB Runtime instances.
     */
    mclTerminateApplication();

    /* Success */
    return 0;
}

int main(int argc, const char ** argv)
{
    /* Call the mclInitializeApplication routine. This initializes the MATLAB Runtime;
     * if this fails, the application cannot run. Make sure that the 
     * application was initialized properly by checking the return status. 
     * This initialization must be done before calling any MATLAB APIs or 
     * MATLAB Compiler SDK generated shared library functions.
     */
    if( !mclInitializeApplication(NULL, 0) )
    {
        fprintf(stderr, "Could not initialize the application.\n");
        return -1;
    }
    return mclRunMain((mclMainFcnType)run_main, argc, argv);
}
